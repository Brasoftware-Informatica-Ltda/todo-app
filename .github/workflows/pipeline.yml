name: Laravel CI/CD Local

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ===============================
  # 1Ô∏è‚É£ BUILD
  # ===============================
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Instalar depend√™ncias
        run: |
          composer install --no-interaction --no-progress --prefer-dist
          cp .env.example .env || true
          php artisan key:generate || true
          php artisan config:cache || true
          php artisan route:cache || true
          php artisan view:cache || true

  # ===============================
  # 2Ô∏è‚É£ QUALIDADE
  # ===============================
  quality:
    runs-on: self-hosted
    needs: build

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Rodar testes PHPUnit
        run: vendor/bin/phpunit --colors=always || true

      - name: Rodar PHPStan (an√°lise est√°tica)
        run: vendor/bin/phpstan analyse --no-progress || true

      - name: Rodar PHP_CodeSniffer (PSR-12)
        run: vendor/bin/phpcs --standard=PSR12 app/ || true

  # ===============================
  # 3Ô∏è‚É£ DEPLOY
  # ===============================
  deploy:
    runs-on: self-hosted
    needs: quality

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Fazer deploy local
        run: |
          echo "üöÄ Iniciando deploy..."
          rm -rf /home/fiocruzlab/todo-app/*
          cp -r ./* /home/fiocruzlab/todo-app/
          cd /home/fiocruzlab/todo-app
          composer install --no-interaction --no-progress --prefer-dist --optimize-autoloader
          php artisan config:cache || true
          php artisan route:cache || true
          php artisan view:cache || true
          echo "‚úÖ Deploy finalizado com sucesso!"
