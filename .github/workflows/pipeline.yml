name: Laravel CI/CD (Self-Hosted)
 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
 
jobs:
  # ===============================
  # 1Ô∏è‚É£ BUILD
  # ===============================
  build:
    runs-on: self-hosted
 
    steps:
      - uses: actions/checkout@v4
 
      - name: Instalar depend√™ncias
        run: |
          composer install --no-interaction --no-progress --prefer-dist
          cp .env.example .env || true
          php artisan key:generate || true
          php artisan config:cache || true
          php artisan route:cache || true
          php artisan view:cache || true
 
  # ===============================
  # 2Ô∏è‚É£ QUALIDADE
  # ===============================
  quality:
    runs-on: self-hosted
    needs: build
 
    steps:
      - uses: actions/checkout@v4
 
      - name: Testes e an√°lise
        run: |
          vendor/bin/phpunit --colors=always || true
          vendor/bin/phpstan analyse --no-progress || true
          vendor/bin/phpcs --standard=PSR12 app/ || true
 
  # ===============================
  # 3Ô∏è‚É£ DEPLOY
  # ===============================
  deploy:
    runs-on: self-hosted
    needs: quality
 
    steps:
      - uses: actions/checkout@v4
 
      - name: Deploy local com rsync
        run: |
          echo "üöÄ Iniciando deploy..."
 
          # Instalar rsync caso n√£o exista
          if ! command -v rsync &> /dev/null; then
            echo "üîß Instalando rsync..."
            sudo yum install -y rsync || sudo apt install -y rsync
          fi
 
          # Sincronizar c√≥digo mantendo permiss√µes e ignorando pastas cr√≠ticas
          rsync -aAX --delete \
            --exclude 'storage' \
            --exclude 'bootstrap/cache' \
            ./ /home/fiocruzlab/todo-app/
 
          # Corrigir permiss√µes e contexto SELinux
          sudo chown -R fiocruzlab:nginx /home/fiocruzlab/todo-app
          sudo chmod -R 775 /home/fiocruzlab/todo-app
          sudo setfacl -R -m u:nginx:rwx,u:fiocruzlab:rwx /home/fiocruzlab/todo-app
          sudo setfacl -R -m d:u:nginx:rwx,d:u:fiocruzlab:rwx /home/fiocruzlab/todo-app
          sudo chcon -R -t httpd_sys_rw_content_t /home/fiocruzlab/todo-app/storage /home/fiocruzlab/todo-app/bootstrap/cache
          sudo restorecon -Rv /home/fiocruzlab/todo-app
 
          # Reconstruir cache do Laravel
          cd /home/fiocruzlab/todo-app
          composer install --no-interaction --no-progress --prefer-dist --optimize-autoloader
          php artisan config:cache || true
          php artisan route:cache || true
          php artisan view:cache || true
 
          echo "‚úÖ Deploy finalizado com sucesso!"
